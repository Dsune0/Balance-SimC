actions.precombat=flask
actions.precombat+=/food
actions.precombat+=/augmentation
actions.precombat+=/snapshot_stats
actions.precombat+=/variable,name=on_use_trinket,value=0
actions.precombat+=/variable,name=on_use_trinket,op=add,value=trinket.1.has_proc.any&trinket.1.cooldown.duration
actions.precombat+=/variable,name=on_use_trinket,op=add,value=(trinket.2.has_proc.any&trinket.2.cooldown.duration)*2
actions.precombat+=/moonkin_form
actions.precombat+=/wrath
actions.precombat+=/wrath

actions=variable,name=is_aoe,value=spell_targets.starfall>1&(!talent.starlord.enabled|talent.stellar_drift.enabled)|spell_targets.starfall>2
actions+=/variable,name=is_cleave,value=spell_targets.starfire>1
actions+=/variable,name=passive_asp,value=(4+talent.orbit_breaker*dot.moonfire.ticking*(buff.orbit_breaker.stack>15)*40)%spell_haste
actions+=/berserking,if=buff.ca_inc.up|fight_remains<15
actions+=/potion,if=buff.ca_inc.up|fight_remains<25
actions+=/use_items,slots=trinket1,if=variable.on_use_trinket!=1&!trinket.2.ready_cooldown|(variable.on_use_trinket=1|variable.on_use_trinket=3)&buff.ca_inc.up|fight_remains<20|variable.on_use_trinket=0
actions+=/use_items,slots=trinket2,if=variable.on_use_trinket!=2&!trinket.1.ready_cooldown|variable.on_use_trinket=2&buff.ca_inc.up|fight_remains<20|variable.on_use_trinket=0
actions+=/use_items
actions+=/run_action_list,name=aoe,if=variable.is_aoe
actions+=/run_action_list,name=st

actions.st=starsurge,if=talent.rattle_the_stars&buff.rattled_stars.up&buff.rattled_stars.remains<gcd.max
actions.st+=/sunfire,target_if=refreshable&astral_power.deficit>variable.passive_asp+3
actions.st+=/moonfire,target_if=refreshable&astral_power.deficit>variable.passive_asp+3
actions.st+=/stellar_flare,target_if=refreshable&astral_power.deficit>variable.passive_asp+8
actions.st+=/celestial_alignment
actions.st+=/incarnation
actions.st+=/convoke_the_spirits,if=buff.ca_inc.remains>4|!talent.primordial_arcanic_pulsar&cooldown.ca_inc.remains>30&(buff.eclipse_lunar.remains>4|buff.eclipse_solar.remains>4)
actions.st+=/warrior_of_elune
actions.st+=/force_of_nature,if=astral_power.deficit>variable.passive_asp+20
actions.st+=/astral_communion,if=astral_power.deficit>variable.passive_asp+75
actions.st+=/variable,name=enter_lunar,value=eclipse.any_next|buff.eclipse_solar.remains<action.wrath.execute_time
actions.st+=/starsurge,if=talent.rattle_the_stars&buff.rattled_stars.up&variable.enter_lunar&buff.rattled_stars.remains<action.starfire.execute_time
actions.st+=/starfire,if=variable.enter_lunar
actions.st+=/fury_of_elune,if=astral_power.deficit>variable.passive_asp+8
actions.st+=/new_moon,if=astral_power.deficit>variable.passive_asp+10&(charges=2&recharge_time<5|charges=3)
actions.st+=/half_moon,if=astral_power.deficit>variable.passive_asp+20
actions.st+=/full_moon,if=astral_power.deficit>variable.passive_asp+40
actions.st+=/starfall,if=buff.starweavers_warp.up
actions.st+=/wrath,if=buff.gathering_starstuff.stack=3&!prev_gcd.2.wrath&astral_power.deficit>variable.passive_asp+6+3*talent.soul_of_the_forest
actions.st+=/starsurge,if=buff.ca_inc.remains<5&buff.ca_inc.up|astral_power.deficit<variable.passive_asp|buff.starweavers_weft.up|(buff.eclipse_lunar.remains<4&buff.eclipse_lunar.up|buff.eclipse_solar.remains<4&buff.eclipse_solar.up)&astral_power>70|talent.starlord&buff.starlord.stack<3|talent.balance_of_all_things&(buff.balance_of_all_things_arcane.stack>5|buff.balance_of_all_things_nature.stack>5)
actions.st+=/new_moon,if=astral_power.deficit>variable.passive_asp+10
actions.st+=/wild_mushroom,if=astral_power.deficit>variable.passive_asp+5&(!talent.fungal_growth|!prev_gcd.1.wild_mushroom&!prev_gcd.2.wild_mushroom&dot.fungal_growth.remains<2)
actions.st+=/starfire,if=buff.warrior_of_elune.up&buff.eclipse_lunar.up
actions.st+=/wrath
actions.st+=/run_action_list,name=fallthru

actions.aoe=sunfire,target_if=refreshable&astral_power.deficit>variable.passive_asp+3&time_to_die>8
actions.aoe+=/moonfire,target_if=refreshable&astral_power.deficit>variable.passive_asp+3&time_to_die>8
actions.aoe+=/stellar_flare,target_if=refreshable&astral_power.deficit>variable.passive_asp+8&time_to_die>8
actions.aoe+=/celestial_alignment
actions.aoe+=/incarnation
actions.aoe+=/convoke_the_spirits,if=buff.ca_inc.up
actions.aoe+=/warrior_of_elune
actions.aoe+=/fury_of_elune,if=astral_power.deficit>variable.passive_asp+8
actions.aoe+=/force_of_nature,if=astral_power.deficit>variable.passive_asp+20
actions.aoe+=/astral_communion,if=astral_power.deficit>variable.passive_asp+75
actions.aoe+=/wrath,if=eclipse.any_next|buff.eclipse_lunar.remains<action.wrath.execute_time
actions.aoe+=/new_moon,if=astral_power.deficit>variable.passive_asp+10&(charges=2&recharge_time<5|charges=3)
actions.aoe+=/half_moon,if=astral_power.deficit>variable.passive_asp+20&(charges=2&recharge_time<5|charges=3)
actions.aoe+=/full_moon,if=astral_power.deficit>variable.passive_asp+40
actions.aoe+=/starfall,if=buff.ca_inc.remains<12&buff.ca_inc.up|astral_power.deficit<variable.passive_asp|buff.starweavers_warp.up|talent.starlord&buff.starlord.stack<3
actions.aoe+=/wild_mushroom,if=astral_power.deficit>variable.passive_asp+20&(!talent.fungal_growth|!prev_gcd.1.wild_mushroom&!prev_gcd.2.wild_mushroom&dot.fungal_growth.remains<2)
actions.aoe+=/new_moon,if=astral_power.deficit>variable.passive_asp+10
actions.aoe+=/half_moon,if=astral_power.deficit>variable.passive_asp+20
actions.aoe+=/starsurge,if=buff.starweavers_weft.up
actions.aoe+=/starfire
actions.aoe+=/run_action_list,name=fallthru

actions.fallthru=starfall,if=variable.is_aoe
actions.fallthru+=/starsurge
actions.fallthru+=/sunfire,target_if=dot.moonfire.remains>remains*22%18
actions.fallthru+=/moonfire
